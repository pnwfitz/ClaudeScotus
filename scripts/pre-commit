#!/bin/bash
#
# ClaudeScotus Pre-commit Hook
# Enforces issue tag requirement in commit messages
# 
# Installation:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Requirement: All commit messages must contain "#ISS-###" tag
#

# Read the commit message
commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Pattern to match: #ISS- followed by 3 digits
issue_pattern='#ISS-[0-9]{3}'

# Check if commit message contains valid issue tag
if ! echo "$commit_msg" | grep -qE "$issue_pattern"; then
    echo "❌ COMMIT REJECTED: Missing issue tag"
    echo ""
    echo "All commits must reference a valid issue using the format: #ISS-###"
    echo ""
    echo "Examples:"
    echo "  ✅ Add pre-commit hook enforcement #ISS-002"
    echo "  ✅ Implement Data Specialist memory triggers #ISS-001"
    echo "  ✅ Draft MVP prediction scope document #ISS-003"
    echo ""
    echo "Current commit message:"
    echo "  $commit_msg"
    echo ""
    echo "Please:"
    echo "  1. Create an issue in /issues/ directory if one doesn't exist"
    echo "  2. Include the issue tag in your commit message"
    echo "  3. Try your commit again"
    echo ""
    echo "For more information, see: issues/README.md"
    exit 1
fi

# Special handling for merge commits
if echo "$commit_msg" | grep -q "^Merge"; then
    echo "✅ Merge commit allowed"
    exit 0
fi

# Validate issue number format (must be 3 digits)
issue_number=$(echo "$commit_msg" | grep -oE '#ISS-[0-9]{3}' | head -1 | sed 's/#ISS-//')

if [ ${#issue_number} -ne 3 ]; then
    echo "❌ COMMIT REJECTED: Invalid issue number format"
    echo ""
    echo "Issue numbers must be exactly 3 digits (zero-padded)"
    echo "Examples: #ISS-001, #ISS-042, #ISS-123"
    echo "Invalid: #ISS-1, #ISS-42, #ISS-1234"
    echo ""
    exit 1
fi

# Check if referenced issue file exists
issue_file_pattern="issues/*_ISS-${issue_number}_*.md"
if ! ls $issue_file_pattern >/dev/null 2>&1; then
    echo "⚠️  WARNING: Issue file not found for #ISS-${issue_number}"
    echo "Expected pattern: issues/YYYY-MM-DD_ISS-${issue_number}_<slug>.md"
    echo ""
    echo "Continuing with commit, but please ensure issue exists..."
fi

echo "✅ Issue tag validated: #ISS-${issue_number}"
exit 0